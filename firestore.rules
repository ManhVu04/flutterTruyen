rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Comics collection
    match /comics/{comicId} {
      allow read: if true;
      allow write: if request.auth != null;
      
      // Reviews subcollection
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if request.auth != null 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.rating is int
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5
                      && request.resource.data.comment is string
                      && request.resource.data.comment.size() > 0
                      && request.resource.data.comment.size() <= 30000;
        allow update: if request.auth != null 
                      && resource.data.userId == request.auth.uid;
        allow delete: if request.auth != null 
                      && resource.data.userId == request.auth.uid;
      }
      
      // Chapters subcollection
      match /chapters/{chapterId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
      
      // Ratings subcollection
      match /ratings/{ratingId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }
    
    // Posts collection
    match /posts/{postId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Forum Posts collection
    match /forumPosts/{postId} {
      allow read: if true;
      
      // Allow users to create their own posts
      allow create: if request.auth != null 
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 1000;
      
      // Allow users to update their own posts, like posts, or update comment count
      allow update: if request.auth != null
                    && (resource.data.authorId == request.auth.uid
                        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedBy', 'updatedAt'])
                        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount', 'updatedAt']));
      
      // Allow users to delete their own posts
      allow delete: if request.auth != null 
                    && resource.data.authorId == request.auth.uid;
    }
    
    // Forum Comments collection
    match /forumComments/{commentId} {
      allow read: if true;
      
      // Allow users to create comments (validate content exists and reasonable length)
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 5000;
      
      // Allow updating replyCount when someone replies
      allow update: if request.auth != null
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']);
      
      // Allow users to delete their own comments
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
    
    // Leaderboard collection
    match /leaderboard/{userId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Chapter Comments collection
    match /chapterComments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      
      // Authenticated users can create comments
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 5000;
      
      // Users can update their own comments (for likes/replies list)
      allow update: if request.auth != null;
      
      // Users can delete their own comments
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
  }
}
